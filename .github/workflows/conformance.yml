name: Conformance

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-quickstart:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
      OGCAPIF_HOST: localhost
    permissions:
      contents: write
      pull-requests: write  # to write comment

    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        uses: docker/login-action@v2
        if: github.repository == 'opengisch/django-ogcapif'
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Django image
        uses: docker/build-push-action@v4
        with:
          context: .
          provenance: false
          file: docker/django/Dockerfile
          push: ${{ github.repository == 'opengisch/django-ogcapif' }}
          pull: true
          cache-from: type=registry,ref=opengisch/signalo-django:latest
          cache-to: type=registry,ref=opengisch/signalo-django:latest,mode=max
          tags: opengisch/signalo-django:latest

      - name: Do quickstart
        run: |
          # copy default conf
          cp .env.example .env

          # start the stack
          docker compose up --build -d

          # deploy static files and migrate database
          docker compose exec django python manage.py collectstatic --no-input
          docker compose exec django python manage.py migrate --no-input
          docker compose exec django python manage.py populate_vl
          docker compose exec django python manage.py populate_signs_poles

      - name: Healthcheck
        run: wget --no-check-certificate https://localhost/oapif/collections/signalo_core.pole/items

      - name: Run conformance test suite
        run: docker compose run conformance_test

      - name: Archive production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: emailable-report
          path: |
            ./_test_outputs/**/emailable-report.html

      - name: Check baseline
        id: baseline
        run: |
          pip install lxml
          EXIT_CODE=0
          python scripts/parse_report.py _test_outputs/emailable-report.html baseline.json  || EXIT_CODE=$?
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT

      - name: Commit baseline if improved (not for forks obvisously)
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.baseline.outputs.exit_code == 1 }}
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.pull_request.head.ref }}
          message: update conformance baseline

      - name: ðŸ’¬ Prepare comment
        id: prepare_comment
        if: ${{ github.event_name == 'pull_request' && steps.baseline.outputs.exit_code != 0 }}
        run : |
          if [[ ${{ steps.baseline.outputs.exit_code }} == 1 ]]; then
            echo "comment=Conformance tests got better! (update baseline if the job fails)" >> $GITHUB_OUTPUT
          else
            echo "comment=Oh no! Conformance tests got worse!" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¬ Create comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: ${{ github.event_name == 'pull_request' && steps.baseline.outputs.exit_code != 0 }}
        with:
          message: ${{ steps.prepare_comment.outputs.comment }}

      - name: Recheck baseline
        run: |
          pip install lxml
          python scripts/parse_report.py _test_outputs/emailable-report.html baseline.json

      - name: Failure logs
        if: failure()
        run: docker-compose logs
